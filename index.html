<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart SOC Incident Response System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/styles.css">
    <link rel="stylesheet" href="assets/shared-buttons.css">
    <link rel="stylesheet" href="assets/chatbot.css">
    <style>
        :root {
            --sidebar-width: 16rem;
            --sidebar-width-collapsed: 4.5rem;
            --sidebar-transition-duration: 300ms;
            --sidebar-transition-ease: ease-in-out;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #d1d5db;
            overflow-x: hidden;
            transition: padding-left var(--sidebar-transition-duration) var(--sidebar-transition-ease);
        }
        
        /* Animated background particles */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }
        .card {
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(55, 65, 81, 0.3);
            border-radius: 0.75rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        /* Ensure smooth button transitions */
        #refresh-alerts-btn {
            transition: all 0.2s ease;
        }
        
        #refresh-alerts-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* Ensure spinner animation works properly */
        .fa-spinner.fa-spin {
            animation: fa-spin 1s infinite linear;
        }
        
        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .glow-effect {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        
        .threat-indicator {
            position: relative;
            overflow: hidden;
        }
        
        .threat-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: scan 3s infinite;
        }
        
        @keyframes scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .table-header {
            background-color: #374151;
            color: #d1d5db;
        }
        .table-row:hover {
            background-color: #374151;
        }
        .severity-high {
            background-color: #991b1b;
            color: #fecaca;
        }
        .severity-medium {
            background-color: #9a3412;
            color: #fdba74;
        }
        .severity-low {
            background-color: #92400e;
            color: #fde68a;
        }
        .status-new {
            background-color: #1d4ed8;
            color: #dbeafe;
        }
        .status-remediated {
            background-color: #166534;
            color: #dcfce7;
        }
        /* Custom scrollbar for log feed */
        .log-feed::-webkit-scrollbar {
            width: 8px;
        }
        .log-feed::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .log-feed::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        .log-feed::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .chatbot-bubble {
            animation: pop-in 0.3s ease-out;
        }
        @keyframes pop-in {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* Chatbot colorful theme */
        .chatbot-window {
            background: radial-gradient(1200px 600px at 100% 100%, rgba(59,130,246,0.12) 0%, rgba(147,51,234,0.10) 40%, rgba(17,24,39,0.9) 70%);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(99,102,241,0.35);
            border-radius: 0.75rem;
            box-shadow: 0 10px 40px rgba(59,130,246,0.2), 0 0 0 1px rgba(147,51,234,0.15) inset;
            overflow: hidden;
        }
        .chatbot-header {
            background: linear-gradient(135deg, rgba(59,130,246,0.35) 0%, rgba(147,51,234,0.35) 100%);
            border-bottom: 1px solid rgba(99,102,241,0.35);
        }
        .chatbot-message-bot {
            background: linear-gradient(135deg, rgba(59,130,246,0.25), rgba(147,51,234,0.25));
            color: #e5e7eb;
            border: 1px solid rgba(99,102,241,0.3);
            border-radius: 0.6rem;
        }
        .chatbot-message-user {
            background: linear-gradient(135deg, rgba(16,185,129,0.25), rgba(59,130,246,0.20));
            color: #f3f4f6;
            border: 1px solid rgba(16,185,129,0.35);
            border-radius: 0.6rem;
        }
        .chatbot-input {
            background: rgba(31,41,55,0.9);
            border: 1px solid rgba(99,102,241,0.35);
            color: #d1d5db;
        }
        .chatbot-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(99,102,241,0.4);
            border-color: rgba(99,102,241,0.6);
        }
        .chatbot-icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: rgba(31,41,55,0.6);
            color: #e5e7eb;
            border: 1px solid rgba(99,102,241,0.35);
            transition: background 0.15s ease;
        }
        .chatbot-icon-btn:hover { background: rgba(55,65,81,0.7); }
        .chatbot-resize-handle {
            position: absolute;
            left: 6px;
            top: 6px;
            width: 14px;
            height: 14px;
            border-left: 2px solid rgba(99,102,241,0.6);
            border-top: 2px solid rgba(99,102,241,0.6);
            cursor: nwse-resize;
            opacity: 0.8;
        }
        /* Animated subtle gradient halo behind the widget */
        .chatbot-halo {
            position: absolute;
            inset: -20%;
            background: conic-gradient(from 180deg at 50% 50%, rgba(59,130,246,0.15), rgba(147,51,234,0.15), rgba(16,185,129,0.12), rgba(59,130,246,0.15));
            filter: blur(40px);
            z-index: -1;
            animation: spin 12s linear infinite;
            border-radius: 50%;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Sidebar collapse (desktop) */
        body.desktop-with-sidebar { padding-left: var(--sidebar-width); }
        body.desktop-with-sidebar-collapsed { padding-left: var(--sidebar-width-collapsed); }
        #sidebar { width: var(--sidebar-width); transition: width var(--sidebar-transition-duration) var(--sidebar-transition-ease), transform var(--sidebar-transition-duration) var(--sidebar-transition-ease); }
        #sidebar.collapsed { width: var(--sidebar-width-collapsed); }
        #sidebar.collapsed nav a { justify-content: center; gap: 0; }
        #sidebar.collapsed nav a span.truncate { display: none; }
        #sidebar.collapsed .brand-text { display: none; }

        /* Mobile open state: prevent background scroll */
        body.sidebar-modal-open { overflow: hidden; }

        /* Sidebar link styling and animations */
        #sidebar nav a.sidebar-link {
            position: relative;
            transition: background-color var(--sidebar-transition-duration) var(--sidebar-transition-ease),
                        color var(--sidebar-transition-duration) var(--sidebar-transition-ease),
                        transform 150ms ease;
            border-radius: 0.5rem;
        }
        #sidebar nav a.sidebar-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
            background: linear-gradient(180deg, rgba(99,102,241,0.8), rgba(147,51,234,0.8));
            opacity: 0;
            transform: scaleY(0.4);
            transition: opacity var(--sidebar-transition-duration) var(--sidebar-transition-ease),
                        transform var(--sidebar-transition-duration) var(--sidebar-transition-ease);
        }
        #sidebar nav a.sidebar-link:hover::before,
        #sidebar nav a.sidebar-link.active::before {
            opacity: 1;
            transform: scaleY(1);
        }
        #sidebar nav a.sidebar-link:hover {
            background: rgba(30, 41, 59, 0.8);
        }
        #sidebar nav a.sidebar-link.active {
            background: rgba(30, 41, 59, 0.95);
            color: #fff;
        }
        #sidebar nav a.sidebar-link .sidebar-icon {
            transition: color var(--sidebar-transition-duration) var(--sidebar-transition-ease), transform 150ms ease;
            color: #94a3b8;
        }
        #sidebar nav a.sidebar-link:hover .sidebar-icon,
        #sidebar nav a.sidebar-link.active .sidebar-icon {
            color: #fff;
            transform: translateX(1px);
        }
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; }
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <!-- Sidebar: SmartSOC Pro -->
    <button id="sidebar-mobile-toggle" class="lg:hidden fixed top-3 left-3 z-50 inline-flex items-center justify-center rounded-md p-2 text-slate-200 bg-slate-900/90 border border-slate-800 hover:bg-slate-800 transition" aria-controls="sidebar" aria-expanded="false" aria-label="Open sidebar">
        <i class="fas fa-bars"></i>
    </button>

    <div id="sidebar-overlay" class="hidden lg:hidden fixed inset-0 z-40 bg-black/40"></div>

    <aside id="sidebar" class="fixed z-50 top-0 left-0 h-screen bg-slate-900 text-slate-200 border-r border-slate-800 transform -translate-x-full lg:translate-x-0" role="dialog" aria-modal="true" aria-label="Sidebar">
        <!-- Brand -->
        <div class="flex items-center justify-between px-4 py-4 border-b border-slate-800">
            <div class="flex items-center gap-3 min-w-0">
                <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-sm font-bold shadow-inner">◆</div>
                <span class="brand-text text-sm font-semibold truncate hidden sm:block">SmartSOC</span>
            </div>
            <button id="sidebar-collapse-toggle" class="hidden lg:inline-flex items-center justify-center rounded-md p-2 text-slate-300 hover:bg-slate-800 transition" aria-controls="sidebar" aria-expanded="true" aria-label="Collapse sidebar">
                <i id="sidebar-collapse-icon-top" class="fas fa-angle-left"></i>
            </button>
            <button id="sidebar-close" class="lg:hidden inline-flex items-center justify-center rounded-md p-2 text-slate-300 hover:bg-slate-800 transition" aria-label="Close sidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Nav -->
        <nav class="px-2 py-3 overflow-y-auto h-[calc(100vh-3.25rem)]">
            <ul class="space-y-1">
                <li>
                    <a href="index.html" class="sidebar-link group relative flex items-center gap-3 rounded-md px-3 py-2 text-slate-300 transition-colors">
                        <i class="sidebar-icon fas fa-gauge-high w-5"></i>
                        <span class="truncate text-sm font-medium">Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="threat-detection.html" class="sidebar-link group relative flex items-center gap-3 rounded-md px-3 py-2 text-slate-300 transition-colors">
                        <i class="sidebar-icon fas fa-triangle-exclamation w-5"></i>
                        <span class="truncate text-sm font-medium">Threat Detection</span>
                    </a>
                </li>
                <li>
                    <a href="cases.html" class="sidebar-link group relative flex items-center gap-3 rounded-md px-3 py-2 text-slate-300 transition-colors">
                        <i class="sidebar-icon fas fa-fire w-5"></i>
                        <span class="truncate text-sm font-medium">Incidents</span>
                    </a>
                </li>
                <li>
                    <a href="threat-intel.html" class="sidebar-link group relative flex items-center gap-3 rounded-md px-3 py-2 text-slate-300 transition-colors">
                        <i class="sidebar-icon fas fa-brain w-5"></i>
                        <span class="truncate text-sm font-medium">Threat Intel</span>
                    </a>
                </li>
                <li>
                    <a href="analytics.html" class="sidebar-link group relative flex items-center gap-3 rounded-md px-3 py-2 text-slate-300 transition-colors">
                        <i class="sidebar-icon fas fa-chart-line w-5"></i>
                        <span class="truncate text-sm font-medium">Analytics</span>
                    </a>
                </li>
                <li>
                    <a href="playbooks.html" class="sidebar-link group relative flex items-center gap-3 rounded-md px-3 py-2 text-slate-300 transition-colors">
                        <i class="sidebar-icon fas fa-diagram-project w-5"></i>
                        <span class="truncate text-sm font-medium">Automation Playbooks</span>
                    </a>
                </li>
                <li>
                    <a href="assets.html" class="sidebar-link group relative flex items-center gap-3 rounded-md px-3 py-2 text-slate-300 transition-colors">
                        <i class="sidebar-icon fas fa-users w-5"></i>
                        <span class="truncate text-sm font-medium">Users</span>
                    </a>
                </li>
                <li>
                    <a href="settings.html" class="sidebar-link group relative flex items-center gap-3 rounded-md px-3 py-2 text-slate-300 transition-colors">
                        <i class="sidebar-icon fas fa-gear w-5"></i>
                        <span class="truncate text-sm font-medium">Settings</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Bottom collapse button for accessibility -->
        <div class="hidden lg:flex absolute bottom-0 left-0 right-0 p-2 border-t border-slate-800">
            <button id="sidebar-collapse-toggle-bottom" class="w-full inline-flex items-center justify-center gap-2 rounded-md px-2 py-2 text-xs text-slate-300 hover:bg-slate-800 transition" aria-controls="sidebar" aria-expanded="true" aria-label="Collapse sidebar">
                <i id="sidebar-collapse-icon-bottom" class="fas fa-angle-left"></i>
            </button>
        </div>
    </aside>
    <!-- Particles.js Background -->
    <div id="particles-js"></div>
    <div id="main-container" class="max-w-7xl mx-auto relative z-10">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-shield-alt text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-white">SmartSOC IRS</h1>
                        <p class="text-sm text-gray-400">AI-Powered Security Operations Center</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-2">
                    <span class="relative flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                    <span id="system-status" class="text-green-400 font-medium">System Active</span>
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-400">
                    <i class="fas fa-clock"></i>
                    <span id="current-time"></span>
                </div>
                <div class="flex items-center space-x-2">
                    <a href="analytics.html" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-chart-line mr-2"></i>Analytics
                    </a>
                    <!-- More button removed per request -->
                    <a href="landing.html" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Grid Layout -->
        <main class="space-y-6">
            <!-- Top Row: Key Metrics Overview -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="card p-6 flex flex-col items-center justify-center threat-indicator">
                    <div class="flex items-center space-x-2 mb-2">
                        <i class="fas fa-chart-line text-blue-400"></i>
                        <h3 class="text-sm font-medium text-gray-400">Total Events</h3>
                    </div>
                    <p id="total-events" class="text-4xl font-bold text-white mb-1">0</p>
                    <div class="flex items-center text-xs text-green-400">
                        <i class="fas fa-arrow-up mr-1"></i>
                        <span>+12% from yesterday</span>
                    </div>
                </div>
                <div class="card p-6 flex flex-col items-center justify-center threat-indicator">
                    <div class="flex items-center space-x-2 mb-2">
                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                        <h3 class="text-sm font-medium text-gray-400">High Alerts</h3>
                    </div>
                    <p id="high-alerts" class="text-4xl font-bold text-red-500 mb-1">0</p>
                    <div class="flex items-center text-xs text-red-400">
                        <i class="fas fa-shield-alt mr-1"></i>
                        <span>Critical threats</span>
                    </div>
                </div>
                <div class="card p-6 flex flex-col items-center justify-center threat-indicator">
                    <div class="flex items-center space-x-2 mb-2">
                        <i class="fas fa-exclamation-circle text-orange-400"></i>
                        <h3 class="text-sm font-medium text-gray-400">Medium Alerts</h3>
                    </div>
                    <p id="medium-alerts" class="text-4xl font-bold text-orange-500 mb-1">0</p>
                    <div class="flex items-center text-xs text-orange-400">
                        <i class="fas fa-eye mr-1"></i>
                        <span>Under review</span>
                    </div>
                </div>
                <div class="card p-6 flex flex-col items-center justify-center threat-indicator">
                    <div class="flex items-center space-x-2 mb-2">
                        <i class="fas fa-info-circle text-yellow-400"></i>
                        <h3 class="text-sm font-medium text-gray-400">Low Alerts</h3>
                    </div>
                    <p id="low-alerts" class="text-4xl font-bold text-yellow-500 mb-1">0</p>
                    <div class="flex items-center text-xs text-yellow-400">
                        <i class="fas fa-check mr-1"></i>
                        <span>Auto-resolved</span>
                    </div>
                </div>
            </div>

            <!-- Middle Row: Critical Operations -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left: Active Incidents & Alerts -->
                <div class="space-y-6">
                    <!-- Alerts Table -->
                    <div class="card p-6 sm:p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-semibold text-white flex items-center text-left">
                                <i class="fas fa-exclamation-triangle mr-3 text-red-400 text-xl"></i>
                                Security Alerts
                            </h2>
                            <div class="flex items-center space-x-3">
                                <span class="text-base text-gray-400">Filter:</span>
                                <button class="bg-red-600 text-white px-3 py-2 rounded text-sm filter-btn hover:bg-red-700 transition-colors" data-severity="High">High</button>
                                <button class="bg-orange-600 text-white px-3 py-2 rounded text-sm filter-btn hover:bg-orange-700 transition-colors" data-severity="Medium">Medium</button>
                                <button class="bg-yellow-600 text-white px-3 py-2 rounded text-sm filter-btn hover:bg-yellow-700 transition-colors" data-severity="Low">Low</button>
                                <button class="bg-gray-600 text-white px-3 py-2 rounded text-sm filter-btn hover:bg-gray-700 transition-colors" data-severity="All">All</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="table-header">
                                    <tr>
                                        <th class="p-4 text-base font-semibold">ID</th>
                                        <th class="p-4 text-base font-semibold">Timestamp</th>
                                        <th class="p-4 text-base font-semibold">Type</th>
                                        <th class="p-4 text-base font-semibold">Severity</th>
                                        <th class="p-4 text-base font-semibold">Status</th>
                                        <th class="p-4 text-base font-semibold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="alerts-table-body">
                                    <!-- Alerts will be dynamically inserted here -->
                                    <tr><td colspan="6" class="text-center p-8 text-gray-500 text-base">No active incidents. Monitoring...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Live Threat Feed -->
                    <div class="card p-6 sm:p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-semibold text-white flex items-center">
                                <i class="fas fa-stream mr-3 text-red-400 text-xl"></i>
                                Live Threat Feed
                                <button id="threat-feed-toggle" class="ml-4 text-gray-400 hover:text-white transition-colors">
                                    <i class="fas fa-chevron-down" id="threat-feed-chevron"></i>
                                </button>
                            </h2>
                            <div class="flex items-center space-x-3">
                                <span class="text-base text-gray-400">Auto-refresh: 2s</span>
                                <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                            </div>
                        </div>
                        <div id="threat-feed-content" class="transition-all duration-300 ease-in-out">
                            <div id="threat-feed" class="space-y-3">
                                <!-- Threat feed items will be populated by JavaScript -->
                            </div>
                            <div id="threat-feed-show-more" class="text-center mt-4 hidden">
                                <button id="show-more-threats" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                    <i class="fas fa-chevron-down mr-2"></i>Show More Threats
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Real-time Analytics & System Health -->
                <div class="space-y-6">
                    <!-- Real-time Analytics Chart -->
                    <div class="card p-4 sm:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-white flex items-center text-left">
                                <i class="fas fa-chart-area mr-3 text-green-400"></i>
                                Real-time Analytics
                            </h2>
                            <div class="flex space-x-2">
                                <button class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-play mr-1"></i>Live
                                </button>
                            </div>
                        </div>
                        <div class="h-64 bg-gray-900 rounded-lg p-4">
                            <canvas id="threatChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- System Health -->
                    <div class="card p-4 sm:p-6">
                        <h2 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <i class="fas fa-heartbeat mr-3 text-green-400"></i>
                            System Health
                        </h2>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-300">CPU Usage</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-20 bg-gray-700 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: 35%"></div>
                                    </div>
                                    <span class="text-sm text-green-400">35%</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-300">Memory Usage</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-20 bg-gray-700 rounded-full h-2">
                                        <div class="bg-yellow-500 h-2 rounded-full" style="width: 68%"></div>
                                    </div>
                                    <span class="text-sm text-yellow-400">68%</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-300">Network I/O</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-20 bg-gray-700 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: 42%"></div>
                                    </div>
                                    <span class="text-sm text-blue-400">42%</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-300">Storage</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-20 bg-gray-700 rounded-full h-2">
                                        <div class="bg-red-500 h-2 rounded-full" style="width: 85%"></div>
                                    </div>
                                    <span class="text-sm text-red-400">85%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Threat Intelligence -->
                    <div id="threat-intelligence-dashboard" class="card p-4 sm:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-white flex items-center">
                                <i class="fas fa-brain mr-3 text-purple-400"></i>
                                Threat Intelligence
                            </h2>
                            <div class="flex space-x-2">
                                <button id="refresh-alerts-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                                </button>
                                <button id="export-pdf-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-download mr-1"></i>Export
                                </button>
                            </div>
                        </div>
                        
                        <!-- Threat Map -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3 text-left">Threat Origins</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center text-left">
                                        <span class="text-sm text-gray-300">Russia</span>
                                        <div class="flex items-center space-x-2">
                                            <div class="w-20 bg-gray-700 rounded-full h-2">
                                                <div class="bg-red-500 h-2 rounded-full" style="width: 85%"></div>
                                            </div>
                                            <span class="text-sm text-red-400">85%</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center text-left">
                                        <span class="text-sm text-gray-300">China</span>
                                        <div class="flex items-center space-x-2">
                                            <div class="w-20 bg-gray-700 rounded-full h-2">
                                                <div class="bg-orange-500 h-2 rounded-full" style="width: 65%"></div>
                                            </div>
                                            <span class="text-sm text-orange-400">65%</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center text-left">
                                        <span class="text-sm text-gray-300">North Korea</span>
                                        <div class="flex items-center space-x-2">
                                            <div class="w-20 bg-gray-700 rounded-full h-2">
                                                <div class="bg-yellow-500 h-2 rounded-full" style="width: 45%"></div>
                                            </div>
                                            <span class="text-sm text-yellow-400">45%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3 text-left">Attack Vectors</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center text-left">
                                        <span class="text-sm text-gray-300">Phishing</span>
                                        <span class="text-sm text-red-400 font-semibold">42%</span>
                                    </div>
                                    <div class="flex justify-between items-center text-left">
                                        <span class="text-sm text-gray-300">Malware</span>
                                        <span class="text-sm text-orange-400 font-semibold">28%</span>
                                    </div>
                                    <div class="flex justify-between items-center text-left">
                                        <span class="text-sm text-gray-300">DDoS</span>
                                        <span class="text-sm text-yellow-400 font-semibold">18%</span>
                                    </div>
                                    <div class="flex justify-between items-center text-left">
                                        <span class="text-sm text-gray-300">Insider</span>
                                        <span class="text-sm text-blue-400 font-semibold">12%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Row: Analysis & Monitoring -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-stretch">
                <!-- Left: Threat Statistics & Performance -->
                <div class="flex flex-col gap-4 min-h-[500px]">
                    <div class="card p-6 sm:p-8 flex-1 flex flex-col min-h-[300px] max-h-[500px] overflow-auto">
                        <h2 class="text-2xl font-semibold text-white flex items-center mb-6 text-left">
                            <i class="fas fa-chart-bar mr-3 text-blue-400 text-xl"></i>
                            Threat Statistics
                            <button id="threat-stats-toggle" class="ml-4 text-gray-400 hover:text-white transition-colors">
                                <i class="fas fa-chevron-down" id="threat-stats-chevron"></i>
                            </button>
                        </h2>
                        <div id="threat-stats-content" class="text-base flex-1 text-center transition-all duration-300 ease-in-out">
                            <div id="threat-stats">
                                <!-- Threat statistics will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="card p-4 sm:p-6 flex-1 flex flex-col min-h-[170px] max-h-[350px] overflow-auto">
                        <h2 class="text-lg font-semibold text-white flex items-center mb-3 text-left">
                            <i class="fas fa-tachometer-alt mr-2 text-purple-400"></i>
                            Performance Metrics
                            <button id="performance-toggle" class="ml-4 text-gray-400 hover:text-white transition-colors">
                                <i class="fas fa-chevron-down" id="performance-chevron"></i>
                            </button>
                        </h2>
                        <div id="performance-content" class="text-sm flex-1 text-center transition-all duration-300 ease-in-out">
                            <div id="performance-metrics">
                                <!-- Performance metrics will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Center: Incident Details -->
                <div class="flex flex-col gap-4 min-h-[350px]">
                    <div id="alert-details-panel" class="card p-6 sm:p-8 flex-1 flex flex-col min-h-[300px]">
                        <h2 class="text-xl font-semibold mb-6 text-white flex items-center">
                            <i class="fas fa-info-circle mr-3 text-blue-400 text-lg"></i>
                            Incident Details
                            <button id="incident-details-toggle" class="ml-4 text-gray-400 hover:text-white transition-colors">
                                <i class="fas fa-chevron-down" id="incident-details-chevron"></i>
                            </button>
                        </h2>
                        <div id="incident-details-content" class="text-gray-400 text-base flex-1 transition-all duration-300 ease-in-out">
                            <div id="alert-details-content">
                                <div class="text-center py-8">
                                    <i class="fas fa-mouse-pointer text-4xl text-gray-600 mb-4"></i>
                                    <p class="text-base">Select an incident from the list to view details.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Live Event Stream -->
                <div class="flex flex-col gap-4 min-h-[350px]">
                    <div class="card p-6 sm:p-8 flex-1 flex flex-col min-h-[300px]">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-semibold text-white flex items-center">
                                <i class="fas fa-stream mr-3 text-purple-400 text-lg"></i>
                                Live Event Stream
                                <button id="live-stream-toggle" class="ml-4 text-gray-400 hover:text-white transition-colors">
                                    <i class="fas fa-chevron-down" id="live-stream-chevron"></i>
                                </button>
                            </h2>
                            <div class="flex items-center space-x-3">
                                <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                                <span class="text-base text-green-400">Live</span>
                            </div>
                        </div>
                        <div id="live-stream-content" class="transition-all duration-300 ease-in-out">
                            <div id="log-feed" class="log-feed bg-gray-900 rounded-md p-4 space-y-2 text-sm flex-1">
                                <!-- Logs will be dynamically inserted here -->
                            </div>
                            <div id="log-feed-show-more" class="text-center mt-4 hidden">
                                <button id="show-more-logs" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                    <i class="fas fa-chevron-down mr-2"></i>Show More Events
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Incidents Section -->
            <div class="w-full mt-6">
                <div class="card p-6 sm:p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-semibold text-white flex items-center">
                            <i class="fas fa-fire mr-3 text-orange-400 text-xl"></i>
                            Active Incidents
                            <button id="incidents-toggle" class="ml-4 text-gray-400 hover:text-white transition-colors">
                                <i class="fas fa-chevron-down" id="incidents-chevron"></i>
                            </button>
                        </h2>
                        <div class="flex items-center space-x-3">
                            <span id="incident-count" class="text-base text-orange-400 font-medium">0 Active</span>
                            <div class="flex space-x-2">
                                <button class="bg-red-600 text-white px-3 py-2 rounded text-sm filter-btn hover:bg-red-700 transition-colors" data-severity="High">High</button>
                                <button class="bg-orange-600 text-white px-3 py-2 rounded text-sm filter-btn hover:bg-orange-700 transition-colors" data-severity="Medium">Medium</button>
                                <button class="bg-yellow-600 text-white px-3 py-2 rounded text-sm filter-btn hover:bg-yellow-700 transition-colors" data-severity="Low">Low</button>
                                <button class="bg-gray-600 text-white px-3 py-2 rounded text-sm filter-btn hover:bg-gray-700 transition-colors" data-severity="All">All</button>
                            </div>
                        </div>
                    </div>
                    <div id="incidents-content" class="transition-all duration-300 ease-in-out">
                        <div id="incidents-list" class="space-y-4">
                            <!-- Incident items will be populated by JavaScript -->
                            <div class="text-center py-8">
                                <i class="fas fa-shield-alt text-4xl text-gray-600 mb-4"></i>
                                <h3 class="text-xl font-semibold text-gray-400 mb-2">No Active Incidents</h3>
                                <p class="text-base text-gray-500">All systems are secure. Monitoring continues...</p>
                            </div>
                        </div>
                        <div id="incidents-show-more" class="text-center mt-4 hidden">
                            <button id="show-more-incidents" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-chevron-down mr-2"></i>Show More Incidents
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    


    <script>
        // Check authentication status
        function checkAuth() {
            const isAuthenticated = sessionStorage.getItem('analytics_authenticated');
            if (!isAuthenticated) {
                window.location.href = 'analytics-login.html';
                return false;
            }
            return true;
        }

        // Initialize authentication check
        if (!checkAuth()) {
            // Redirect to login page
            window.location.href = 'analytics-login.html';
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('analytics_authenticated');
                window.location.href = 'analytics-login.html';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 'More' menu removed — no wiring required
            // Toast utility
            function showToast(msg, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `fixed top-6 right-6 z-50 px-4 py-2 rounded shadow-lg text-white font-semibold toast-${type}`;
                toast.style.background = type === 'success' ? '#16a34a' : type === 'error' ? '#dc2626' : '#2563eb';
                toast.textContent = msg;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            }
            // PDF Export
            document.getElementById('export-pdf-btn').onclick = function() {
                showToast('Exporting alerts to PDF...', 'info');
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const currentTime = new Date().toLocaleString();
                    
                    // Header
                    doc.setFontSize(20);
                    doc.text('SOC Alerts Report', 20, 20);
                    doc.setFontSize(12);
                    doc.text(`Generated on: ${currentTime}`, 20, 30);
                    doc.text(`Total Alerts: ${alerts.length}`, 20, 35);
                    
                    let yPosition = 50;
                    
                    if (alerts.length === 0) {
                        doc.text('No alerts to display.', 20, yPosition);
                    } else {
                        alerts.forEach((alert, index) => {
                            if (yPosition > 280) {
                                doc.addPage();
                                yPosition = 20;
                            }
                            
                            // Alert header
                            doc.setFontSize(14);
                            doc.text(`Alert #${alert.id} - ${alert.type}`, 20, yPosition);
                            yPosition += 10;
                            
                            // Alert details
                            doc.setFontSize(10);
                            doc.text(`Severity: ${alert.severity}`, 20, yPosition);
                            yPosition += 7;
                            doc.text(`Status: ${alert.status}`, 20, yPosition);
                            yPosition += 7;
                            doc.text(`Timestamp: ${alert.timestamp.toLocaleString()}`, 20, yPosition);
                            yPosition += 7;
                            doc.text(`Description: ${alert.description}`, 20, yPosition);
                            yPosition += 15;
                            
                            // Add line separator
                            if (index < alerts.length - 1) {
                                doc.line(20, yPosition, 190, yPosition);
                                yPosition += 10;
                            }
                        });
                    }
                    
                    // Save the PDF
                    doc.save(`SOC_Alerts_Report_${new Date().toISOString().split('T')[0]}.pdf`);
                    showToast('PDF exported successfully!', 'success');
                } catch (error) {
                    console.error('PDF generation error:', error);
                    showToast('Error generating PDF', 'error');
                }
            };
            // Chatbot wiring
            const chatbotToggle = document.getElementById('chatbot-toggle');
            const chatbotWindow = document.getElementById('chatbot-window');
            const chatbotMessages = document.getElementById('chatbot-messages');
            const chatbotInput = document.getElementById('chatbot-input');
            const CHAT_HISTORY_KEY = 'smartsoc_chat_history_v1';
            let chatbotHistory = [];

            function loadChatHistory() {
                try {
                    const raw = localStorage.getItem(CHAT_HISTORY_KEY);
                    const parsed = raw ? JSON.parse(raw) : [];
                    if (Array.isArray(parsed)) return parsed.filter(m => m && typeof m.role === 'string' && typeof m.content === 'string');
                } catch (_) {}
                return [];
            }
            function saveChatHistory() {
                try { localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(chatbotHistory)); } catch (_) {}
            }
            function clearChatHistory() {
                chatbotHistory = [];
                saveChatHistory();
            }
            let chatbotBusy = false;

            function escapeHtml(text) {
                return text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            function renderMarkdownBasic(md) {
                // Escape any HTML first
                let html = escapeHtml(md);
                // Headings (##, ###)
                html = html.replace(/^###\s+(.*)$/gm, '<h3 class="font-semibold text-white mb-1">$1<\/h3>');
                html = html.replace(/^##\s+(.*)$/gm, '<h2 class="font-semibold text-white mb-1">$1<\/h2>');
                // Bold and italics
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1<\/strong>');
                html = html.replace(/\*(.*?)\*/g, '<em>$1<\/em>');
                // Inline code
                html = html.replace(/`([^`]+)`/g, '<code class="bg-gray-800 px-1 rounded text-gray-200">$1<\/code>');
                // Unordered lists
                html = html.replace(/^(\s*-\s+.*(?:\n\s*-\s+.*)*)/gm, function(match) {
                    const items = match.split(/\n/).map(line => line.replace(/^\s*-\s+(.*)$/, '<li class="ml-4">$1<\/li>')).join('');
                    return '<ul class="list-disc pl-4 my-2">' + items + '<\/ul>';
                });
                // Ordered lists
                html = html.replace(/^(\s*\d+\.\s+.*(?:\n\s*\d+\.\s+.*)*)/gm, function(match) {
                    const items = match.split(/\n/).map(line => line.replace(/^\s*\d+\.\s+(.*)$/, '<li class="ml-4">$1<\/li>')).join('');
                    return '<ol class="list-decimal pl-4 my-2">' + items + '<\/ol>';
                });
                // Line breaks
                html = html.replace(/\n/g, '<br/>');
                return html;
            }

            function addChatMessage(message, sender) {
                const messageEl = document.createElement('div');
                messageEl.className = sender === 'user' ? 'text-sm p-2 chatbot-message-user mb-2 text-right' : 'text-sm p-2 chatbot-message-bot mb-2';
                if (sender === 'bot') {
                    messageEl.innerHTML = renderMarkdownBasic(String(message || ''));
                } else {
                messageEl.textContent = message;
                }
                chatbotMessages.appendChild(messageEl);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }

            function addTyping() {
                const el = document.createElement('div');
                el.id = 'chatbot-typing';
                el.className = 'text-sm p-2 bg-blue-900/30 rounded-lg text-gray-400 mb-2 italic';
                el.textContent = 'Typing…';
                chatbotMessages.appendChild(el);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }

            function removeTyping() {
                const el = document.getElementById('chatbot-typing');
                if (el) el.remove();
            }

            chatbotToggle?.addEventListener('click', () => {
                chatbotWindow?.classList.toggle('hidden');
                if (!chatbotWindow?.classList.contains('hidden')) {
                    chatbotInput?.focus();
                }
            });

            const chatbotClose = document.getElementById('chatbot-close');
            chatbotClose?.addEventListener('click', () => {
                const win = document.getElementById('chatbot-window');
                win?.classList.add('hidden');
            });

            // Chatbot resizing logic
            (function() {
                const win = document.getElementById('chatbot-window');
                const msgs = document.getElementById('chatbot-messages');
                const btnS = document.getElementById('chatbot-size-sm');
                const btnM = document.getElementById('chatbot-size-md');
                const btnL = document.getElementById('chatbot-size-lg');
                const handle = win?.querySelector('.chatbot-resize-handle');

                function setSize(widthPx, heightPx) {
                    if (!win || !msgs) return;
                    win.style.width = widthPx + 'px';
                    win.style.height = heightPx + 'px';
                    // header (p-4 ~ 32px), input (p-2 ~ 16px + input 32px + border), paddings
                    const headerH = 56; // approximate
                    const inputH = 64; // approximate
                    const padding = 24; // paddings/margins
                    const messagesHeight = Math.max(160, heightPx - (headerH + inputH + padding));
                    msgs.style.height = messagesHeight + 'px';
                }

                btnS?.addEventListener('click', () => setSize(320, 360));
                btnM?.addEventListener('click', () => setSize(380, 440));
                btnL?.addEventListener('click', () => setSize(460, 560));

                // Drag-to-resize with handle
                let resizing = false;
                let startX = 0, startY = 0, startW = 0, startH = 0;

                function onMouseMove(e) {
                    if (!resizing) return;
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    // Top-left anchored resizing: invert deltas
                    const newW = Math.max(300, startW - dx);
                    const newH = Math.max(300, startH - dy);
                    setSize(newW, newH);
                }

                function onMouseUp() {
                    resizing = false;
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                handle?.addEventListener('mousedown', (e) => {
                    if (!win) return;
                    resizing = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startW = win.offsetWidth;
                    startH = win.offsetHeight;
                    e.preventDefault();
                    e.stopPropagation();
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });

                // Set default size on open
                if (win && !win.classList.contains('hidden')) setSize(win.offsetWidth, win.offsetHeight || 420);
            })();

            chatbotInput?.addEventListener('keyup', (e) => {
                if (e.key === 'Enter' && chatbotInput.value.trim() !== '') {
                    const q = chatbotInput.value.trim();
                    chatbotInput.value = '';
                    addChatMessage(q, 'user');
                    chatbotHistory.push({ role: 'user', content: q });
                    try { localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(chatbotHistory)); } catch (_) {}
                    processChatbotQuery(q);
                }
            });

            function buildSocContext() {
                try {
                    const alertsSummary = (Array.isArray(alerts) ? alerts.slice(0, 3) : []).map(a => `#${a.id} ${a.type} (${a.severity}) - ${a.status}`).join(' | ');
                    const counts = `Events=${typeof totalEvents !== 'undefined' ? totalEvents : 0}, High=${typeof highAlerts !== 'undefined' ? highAlerts : 0}, Medium=${typeof mediumAlerts !== 'undefined' ? mediumAlerts : 0}, Low=${typeof lowAlerts !== 'undefined' ? lowAlerts : 0}`;
                    const now = new Date().toLocaleString();
                    return `Current SmartSOC status as of ${now}: ${counts}. Recent alerts: ${alertsSummary || 'none'}.`;
                } catch (_) {
                    return 'Current SmartSOC status: metrics unavailable.';
                }
            }

            // Restore history once on load
            chatbotHistory = loadChatHistory();
            if (Array.isArray(chatbotHistory) && chatbotHistory.length > 0) {
                chatbotMessages.innerHTML = '';
                chatbotHistory.forEach(m => addChatMessage(m.content, m.role === 'user' ? 'user' : 'bot'));
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }

            async function processChatbotQuery(query) {
                if (chatbotBusy) return;
                chatbotBusy = true;

                const systemPrompt = 'You are the SmartSOC Assistant embedded in the Smart SOC Incident Response System (SmartSOC IRS). You help security analysts with SOC operations: interpreting alerts, incident triage, phishing analysis, threat intelligence, and safe remediation guidance. If asked about yourself, say you are the SmartSOC Assistant integrated into this app and currently powered by Groq. Respond in clean, ChatGPT-style markdown with short headings (##/###), bold labels, concise bullet points, and numbered steps for playbooks. Keep responses concise, accurate, and action-oriented. Avoid giving instructions that could enable harm. When information is missing, ask a brief clarifying question before proceeding. Where helpful, include concrete next steps.';
                const maxTurns = 10;
                const recentTurns = chatbotHistory.slice(-maxTurns).map(m => ({ role: m.role === 'assistant' ? 'assistant' : m.role, content: m.content }));
                const messages = [
                    { role: 'system', content: systemPrompt },
                    { role: 'system', content: buildSocContext() },
                    ...recentTurns,
                    { role: 'user', content: query }
                ];

                try {
                    const GROQ_API_KEY = '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';
                    const url = 'https://api.groq.com/openai/v1/chat/completions';
                    addTyping();
                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + GROQ_API_KEY },
                        body: JSON.stringify({
                            model: 'openai/gpt-oss-120b',
                            messages,
                            temperature: 0.6,
                            max_tokens: 512
                        })
                    });
                    if (!resp.ok) {
                        let msg = 'The AI service returned an error. Please try again.';
                        try {
                            const err = await resp.json();
                            if (err && err.error && err.error.message) msg = err.error.message;
                        } catch (_) {
                            const errText = await resp.text();
                            if (errText) msg = errText;
                        }
                        console.error('Gemini error', resp.status, msg);
                        removeTyping();
                        addChatMessage(msg, 'bot');
                        return;
                    }
                    const data = await resp.json();
                    let text = '';
                    if (data && Array.isArray(data.choices) && data.choices.length > 0) {
                        const msg = data.choices[0].message;
                        if (msg && typeof msg.content === 'string') text = msg.content;
                    }
                    removeTyping();
                    if (!text) text = 'Sorry, I could not get a response right now. Please try again.';
                    addChatMessage(text, 'bot');
                    chatbotHistory.push({ role: 'assistant', content: text });
                    try { localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(chatbotHistory)); } catch (_) {}
                } catch (e) {
                    console.error('Gemini request failed', e);
                    removeTyping();
                    const errMsg = 'I\'m having trouble reaching the AI service. Please try again.';
                    addChatMessage(errMsg, 'bot');
                    chatbotHistory.push({ role: 'assistant', content: errMsg });
                    try { localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(chatbotHistory)); } catch (_) {}
                } finally {
                    chatbotBusy = false;
                }
            }
            // Refresh alerts
            document.getElementById('refresh-alerts-btn').onclick = function() {
                // Prevent multiple clicks
                if (this.disabled) return;
                
                // Store reference to button
                const refreshBtn = this;
                const originalHTML = '<i class="fas fa-sync-alt mr-1"></i>Refresh Alerts';
                
                // Add spinning animation to refresh button
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Refreshing...';
                refreshBtn.disabled = true;
                refreshBtn.style.pointerEvents = 'none';
                
                showToast('Refreshing Threat Intelligence Dashboard...', 'info');
                
                // Add a subtle highlight effect to show refresh is happening
                const dashboardSection = document.querySelector('#threat-intelligence-dashboard');
                if (dashboardSection) {
                    dashboardSection.style.transition = 'box-shadow 0.3s ease';
                    dashboardSection.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.5)';
                }
                
                // Reload the entire Threat Intelligence Dashboard section
                setTimeout(() => {
                    // Just re-render the existing alerts without adding new ones
                renderAlerts();
                    updateStats();
                    
                    // Reset button state
                    refreshBtn.innerHTML = originalHTML;
                    refreshBtn.disabled = false;
                    refreshBtn.style.pointerEvents = 'auto';
                    
                    // Remove highlight effect
                    if (dashboardSection) {
                        dashboardSection.style.boxShadow = '';
                    }
                    
                    showToast(`Threat Intelligence Dashboard refreshed! Showing ${alerts.length} alerts.`, 'success');
                }, 500); // 0.5 second delay
            };
            // Severity filter
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.onclick = function() {
                    const sev = this.dataset.severity;
                    showToast(`Filtering: ${sev}`, 'info');
                    let filtered = sev === 'All' ? alerts : alerts.filter(a => a.severity === sev);
                    alertsTableBody.innerHTML = '';
                    filtered.forEach(alert => {
                        const row = document.createElement('tr');
                        row.className = 'table-row cursor-pointer border-b border-gray-700 hover:bg-gray-800 transition-colors';
                        row.dataset.alertId = alert.id;
                        const severityIcon = alert.severity === 'High' ? 'fas fa-exclamation-triangle' : alert.severity === 'Medium' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle';
                        const statusIcon = alert.status === 'New' ? 'fas fa-clock' : alert.status === 'Remediated' ? 'fas fa-check-circle' : 'fas fa-times-circle';
                        row.innerHTML = `
                            <td class="p-3 font-medium text-blue-400">#${alert.id}</td>
                            <td class="p-3 text-gray-300">${alert.timestamp.toLocaleTimeString()}</td>
                            <td class="p-3 text-white">${alert.type}</td>
                            <td class="p-3">
                                <span class="px-3 py-1 text-xs font-semibold rounded-full severity-${alert.severity.toLowerCase()} flex items-center w-fit">
                                    <i class="${severityIcon} mr-1"></i>
                                    ${alert.severity}
                                </span>
                            </td>
                            <td class="p-3">
                                <span onclick="event.stopPropagation();" class="px-3 py-1 text-xs font-semibold rounded-full status-${alert.status.toLowerCase()} flex items-center w-fit cursor-default">
                                    <i class="${statusIcon} mr-1"></i>
                                    ${alert.status}
                                </span>
                            </td>
                            <td class="p-3">
                                <div class="flex space-x-2">
                                    <button onclick="event.stopPropagation(); displayAlertDetails(${alert.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs"><i class="fas fa-eye mr-1"></i>View</button>
                                    ${alert.status === 'New' ? `<button onclick="event.stopPropagation(); handleRemediation({target: {dataset: {alertId: ${alert.id}, stepIndex: 0}}})" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs"><i class="fas fa-check mr-1"></i>Fix</button>` : ''}
                                </div>
                            </td>
                        `;
                        row.addEventListener('click', () => {
                            window.location.href = `incident-details.html?id=${alert.id}`;
                        });
                        alertsTableBody.appendChild(row);
                    });
                };
            });
            // Initialize particles.js
            particlesJS('particles-js', {
                particles: {
                    number: { value: 80 },
                    color: { value: '#3b82f6' },
                    shape: { type: 'circle' },
                    opacity: { value: 0.5, random: true },
                    size: { value: 3, random: true },
                    line_linked: { enable: true, distance: 150, color: '#3b82f6', opacity: 0.4, width: 1 },
                    move: { enable: true, speed: 2, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
                },
                interactivity: {
                    detect_on: 'canvas',
                    events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true },
                    modes: { grab: { distance: 400, line_linked: { opacity: 1 } }, bubble: { distance: 400, size: 40, duration: 2, opacity: 8, speed: 3 }, repulse: { distance: 200, duration: 0.4 }, push: { particles_nb: 4 }, remove: { particles_nb: 2 } }
                },
                retina_detect: true
                });

                // Load shared particles initializer (kept for backward compatibility)
                var s = document.createElement('script');
                s.src = 'assets/particles-init.js';
                document.head.appendChild(s);

            // --- DOM Elements ---
            const totalEventsEl = document.getElementById('total-events');
            const highAlertsEl = document.getElementById('high-alerts');
            const mediumAlertsEl = document.getElementById('medium-alerts');
            const lowAlertsEl = document.getElementById('low-alerts');
            const alertsTableBody = document.getElementById('alerts-table-body');
            const logFeedEl = document.getElementById('log-feed');
            const alertDetailsPanel = document.getElementById('alert-details-content');
            
            const currentTimeEl = document.getElementById('current-time');
            
            // Initialize real-time chart
            const ctx = document.getElementById('threatChart').getContext('2d');
            const threatChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Threats Detected',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Events Processed',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#d1d5db' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' }
                        },
                        y: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });

            // Update current time
            function updateTime() {
                const now = new Date();
                currentTimeEl.textContent = now.toLocaleTimeString();
            }
            updateTime();
            setInterval(updateTime, 1000);

            // --- State Management ---
            let totalEvents = 0;
            let highAlerts = 0;
            let mediumAlerts = 0;
            let lowAlerts = 0;
            let alertIdCounter = 1;
            let alerts = [];

            // Blocklists to simulate remediation actions taking effect
            const blockedIPs = new Set();
            const blockedUsers = new Set();
            const blockedDestinations = new Set();

            // --- Detection Logic State ---
            const failedLoginAttempts = {}; // { ip: { count, timestamps: [] } }
            const knownMaliciousDomains = ['malware-distro.ru', 'phishing-paradise.com', 'badfiles.net'];
            
            // --- Real-time Log Processing ---
            const userPool = [
                { name: 'alice', role: 'user' }, { name: 'bob', role: 'user' }, { name: 'charlie', role: 'admin' }, 
                { name: 'dave', role: 'user' }, { name: 'eve', role: 'guest' }
            ];
            const ipPool = ['192.168.1.10', '10.0.0.5', '203.0.113.45', '172.16.31.88', '198.51.100.2'];
            const actions = ['login_success', 'login_failure', 'file_access', 'file_upload', 'db_query', 'admin_login', 'delete_database', 'firewall_change'];
            
            function generateLog() {
                const user = userPool[Math.floor(Math.random() * userPool.length)];
                const ip = ipPool[Math.floor(Math.random() * ipPool.length)];
                
                // --- Real Threat Detection Scenarios ---
                const threatType = Math.random();
                if (threatType < 0.05) { // Brute Force Attack
                    for (let i = 0; i < 5; i++) {
                         setTimeout(() => createAndProcessLog(generateBruteForceLog('81.2.69.142', user.name)), i * 200);
                    }
                    return null; // Don't generate a normal log this cycle
                }
                if (threatType < 0.10) { // Insider Threat Detection
                     return generateInsiderThreatLog();
                }
                if (threatType < 0.15) { // Data Exfiltration Detection
                    return generateExfiltrationLog();
                }
                if (threatType < 0.20) { // Malware Detection
                    return generateMalwareLog();
                }

                // Normal activity processing
                return {
                    timestamp: new Date().toISOString(),
                    source_ip: ip,
                    user: user.name,
                    user_role: user.role,
                    action: actions[Math.floor(Math.random() * actions.length)],
                    status: 'success',
                    data_size_kb: Math.floor(Math.random() * 1000),
                    destination: ipPool.filter(i => i !== ip)[0]
                };
            }

            // --- Real Threat Detection Log Generators ---
            function generateBruteForceLog(ip, user) {
                return {
                    timestamp: new Date().toISOString(),
                    source_ip: ip, user: user, user_role: 'user', action: 'login_failure', status: 'failure',
                    data_size_kb: 1, destination: 'auth_server'
                };
            }
            function generateInsiderThreatLog() {
                 return {
                    timestamp: new Date().toISOString(),
                    source_ip: '10.1.1.25', user: 'dave', user_role: 'user', action: 'delete_database',
                    status: 'denied', data_size_kb: 5, destination: 'prod_db_server'
                };
            }
            function generateExfiltrationLog() {
                return {
                    timestamp: new Date().toISOString(),
                    source_ip: '172.16.31.88', user: 'bob', user_role: 'user', action: 'file_upload',
                    status: 'success', data_size_kb: 25000, destination: '104.26.10.189'
                };
            }
            function generateMalwareLog() {
                return {
                    timestamp: new Date().toISOString(),
                    source_ip: '192.168.1.10', user: 'alice', user_role: 'user', action: 'dns_query',
                    status: 'success', data_size_kb: 1, destination: 'malware-distro.ru'
                };
            }

            // --- Analysis & Detection Engine ---
            function analyzeLog(log) {
                // If entity is blocked, short-circuit and annotate feed
                if (blockedIPs.has(log.source_ip) || blockedUsers.has(log.user) || blockedDestinations.has(log.destination)) {
                    const blockedMsg = `Blocked event from ${blockedIPs.has(log.source_ip) ? 'IP ' + log.source_ip : blockedUsers.has(log.user) ? 'user ' + log.user : 'destination ' + log.destination}`;
                    addLogToFeed({
                        timestamp: new Date().toISOString(),
                        source_ip: log.source_ip,
                        user: log.user,
                        action: 'blocked',
                        status: 'denied'
                    });
                    return; // Do not analyze blocked events
                }
                // 1. Brute Force Detection
                if (log.action === 'login_failure') {
                    const ip = log.source_ip;
                    if (!failedLoginAttempts[ip]) {
                        failedLoginAttempts[ip] = { count: 0, timestamps: [] };
                    }
                    const now = Date.now();
                    failedLoginAttempts[ip].count++;
                    failedLoginAttempts[ip].timestamps.push(now);
                    // Prune old attempts (older than 60s)
                    failedLoginAttempts[ip].timestamps = failedLoginAttempts[ip].timestamps.filter(ts => now - ts < 60000);
                    failedLoginAttempts[ip].count = failedLoginAttempts[ip].timestamps.length;

                    if (failedLoginAttempts[ip].count >= 5) {
                        const alertType = 'Brute Force Login Attempt';
                        if (!isAlertActive(alertType, 'source_ip', ip)) {
                            createAlert('High', alertType, 
                                `Multiple failed login attempts detected from IP: ${ip}.`, 
                                { source_ip: ip, user: log.user },
                                [`Block IP Address: ${ip}`, `Reset and monitor user account: ${log.user}`]
                            );
                            failedLoginAttempts[ip] = { count: 0, timestamps: [] }; // Reset after alert
                        }
                    }
                }
                
                // 2. Insider Privilege Misuse Detection
                if (log.user_role === 'user' && (log.action.includes('delete_') || log.action.includes('admin_') || log.action.includes('change_'))) {
                    const alertType = 'Insider Privilege Misuse';
                    if (!isAlertActive(alertType, 'user', log.user)) {
                         createAlert('Medium', alertType,
                            `User '${log.user}' attempted an unauthorized privileged action: '${log.action}'.`,
                            { source_ip: log.source_ip, user: log.user },
                            [`Investigate user activity: ${log.user}`, `Confirm user permissions`, `Temporarily disable account: ${log.user}`]
                        );
                    }
                }

                // 3. Data Exfiltration Detection
                if (log.action === 'file_upload' && log.data_size_kb > 20000) {
                     const alertType = 'Potential Data Exfiltration';
                     if (!isAlertActive(alertType, 'source_ip', log.source_ip)) {
                         createAlert('High', alertType,
                            `Unusually large data upload (${log.data_size_kb} KB) from ${log.source_ip} to ${log.destination}.`,
                            { source_ip: log.source_ip, user: log.user, destination: log.destination },
                            [`Isolate host: ${log.source_ip}`, `Analyze network traffic from host`, `Disable user account: ${log.user}`]
                        );
                     }
                }
                
                // 4. Malware Indicator Detection
                if (knownMaliciousDomains.includes(log.destination)) {
                    const alertType = 'Malware Beaconing Detected';
                    if (!isAlertActive(alertType, 'source_ip', log.source_ip)) {
                         createAlert('High', alertType,
                            `Host ${log.source_ip} contacted a known malicious domain: ${log.destination}.`,
                            { source_ip: log.source_ip, user: log.user, destination: log.destination },
                            [`Isolate host: ${log.source_ip}`, `Scan host for malware`, `Block domain on firewall: ${log.destination}`]
                        );
                    }
                }

                // 5. Low Severity: Unusual File Access Volume
                if (log.action === 'file_access' && log.data_size_kb >= 500 && log.data_size_kb < 5000) {
                    const alertType = 'Unusual File Access Volume';
                    const uniqueKey = `${log.user}-${log.source_ip}`;
                    if (!isAlertActive(alertType, 'key', uniqueKey)) {
                        createAlert('Low', alertType,
                            `User ${log.user} accessed a higher-than-usual volume of data (${log.data_size_kb} KB).`,
                            { key: uniqueKey, source_ip: log.source_ip, user: log.user },
                            [`Review recent file activity for ${log.user}`, `Confirm business justification`]
                        );
                    }
                }

                // 6. Low Severity: Unusual Database Activity
                if (log.action === 'db_query' && log.data_size_kb >= 800 && log.data_size_kb < 8000) {
                    const alertType = 'Unusual Database Activity';
                    const uniqueKey = `${log.user}-${log.source_ip}`;
                    if (!isAlertActive(alertType, 'key', uniqueKey)) {
                        createAlert('Low', alertType,
                            `Database activity by ${log.user} shows elevated volume (${log.data_size_kb} KB).`,
                            { key: uniqueKey, source_ip: log.source_ip, user: log.user },
                            [`Audit recent DB queries by ${log.user}`, `Validate access patterns`]
                        );
                    }
                }
            }

            // --- UI Update Functions ---
            function updateStats() {
                totalEventsEl.textContent = totalEvents;
                highAlertsEl.textContent = highAlerts;
                mediumAlertsEl.textContent = mediumAlerts;
                lowAlertsEl.textContent = lowAlerts;
            }

            function addLogToFeed(log) {
                const logEntry = document.createElement('div');
                logEntry.className = 'text-xs p-1 rounded';
                let colorClass = 'text-gray-400';
                if(log.status === 'failure' || log.status === 'denied') colorClass = 'text-red-400';
                if(log.action.includes('login_success')) colorClass = 'text-green-400';

                logEntry.innerHTML = `<span class="${colorClass}">${log.timestamp.split('T')[1].replace('Z','')}</span> | <span class="text-blue-400">${log.source_ip}</span> -> <span class="text-yellow-400">${log.action}</span> | User: ${log.user}`;
                logFeedEl.prepend(logEntry);
                
                // Show "Show More" button if more than 5 logs
                const logs = logFeedEl.children;
                const showMoreBtn = document.getElementById('log-feed-show-more');
                if (logs.length > 5 && showMoreBtn) {
                    showMoreBtn.classList.remove('hidden');
                }
                
                // Hide logs beyond the first 5 initially
                updateLogFeedVisibility();
                
                if(logFeedEl.childElementCount > 100) {
                    logFeedEl.removeChild(logFeedEl.lastChild);
                }
            }

            function updateLogFeedVisibility() {
                const logs = logFeedEl.children;
                const showMoreBtn = document.getElementById('show-more-logs');
                const isExpanded = showMoreBtn && showMoreBtn.textContent.includes('Show Less');
                
                logs.forEach((log, index) => {
                    if (index >= 5 && !isExpanded) {
                        log.style.display = 'none';
                    } else {
                        log.style.display = 'block';
                    }
                });
            }
            
            function createAndProcessLog(log) {
                if (!log) return;
                totalEvents++;
                addLogToFeed(log);
                analyzeLog(log);
                updateStats();
                updateChart();
            }

            // Update real-time chart
            function updateChart() {
                const now = new Date();
                const timeLabel = now.toLocaleTimeString();
                
                // Add new data point
                threatChart.data.labels.push(timeLabel);
                threatChart.data.datasets[0].data.push(highAlerts + mediumAlerts + lowAlerts);
                threatChart.data.datasets[1].data.push(totalEvents);
                
                // Keep only last 20 data points
                if (threatChart.data.labels.length > 20) {
                    threatChart.data.labels.shift();
                    threatChart.data.datasets[0].data.shift();
                    threatChart.data.datasets[1].data.shift();
                }
                
                threatChart.update('none');
            }

            function isAlertActive(type, key, value) {
                return alerts.some(a => a.type === type && a.details[key] === value && a.status === 'New');
            }

            function createAlert(severity, type, description, details, remediation) {
                if(alerts.length === 0) alertsTableBody.innerHTML = ''; // Clear initial message
                
                const newAlert = {
                    id: alertIdCounter++,
                    timestamp: new Date(),
                    severity, type, description, details, remediation,
                    status: 'New'
                };
                alerts.unshift(newAlert);
                
                if (severity === 'High') highAlerts++;
                else if (severity === 'Medium') mediumAlerts++;
                else lowAlerts++;

                updateStats();
                renderAlerts();
            }

            function renderAlerts() {
                alertsTableBody.innerHTML = '';
                alerts.forEach(alert => {
                    const row = document.createElement('tr');
                    row.className = 'table-row cursor-pointer border-b border-gray-700 hover:bg-gray-800 transition-colors';
                    row.dataset.alertId = alert.id;
                    
                    const severityIcon = alert.severity === 'High' ? 'fas fa-exclamation-triangle' : 
                                       alert.severity === 'Medium' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle';
                    
                    const statusIcon = alert.status === 'New' ? 'fas fa-clock' : 
                                     alert.status === 'Remediated' ? 'fas fa-check-circle' : 'fas fa-times-circle';
                    
                    row.innerHTML = `
                        <td class="p-3 font-medium text-blue-400">#${alert.id}</td>
                        <td class="p-3 text-gray-300">${alert.timestamp.toLocaleTimeString()}</td>
                        <td class="p-3 text-white">${alert.type}</td>
                        <td class="p-3">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full severity-${alert.severity.toLowerCase()} flex items-center w-fit">
                                <i class="${severityIcon} mr-1"></i>
                                ${alert.severity}
                            </span>
                        </td>
                        <td class="p-3">
                            <span onclick="event.stopPropagation();" class="px-3 py-1 text-xs font-semibold rounded-full status-${alert.status.toLowerCase()} flex items-center w-fit cursor-default">
                                <i class="${statusIcon} mr-1"></i>
                                ${alert.status}
                            </span>
                        </td>
                        <td class="p-3">
                            <div class="flex space-x-2">
                                <button onclick="event.stopPropagation(); displayAlertDetails(${alert.id})" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-eye mr-1"></i>View
                                </button>
                                ${alert.status === 'New' ? `
                                <button onclick="event.stopPropagation(); handleRemediation({target: {dataset: {alertId: ${alert.id}, stepIndex: 0}}})" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-check mr-1"></i>Fix
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                    row.addEventListener('click', () => {
                        window.location.href = `incident-details.html?id=${alert.id}`;
                    });
                    alertsTableBody.appendChild(row);
                });
            }

            function displayAlertDetails(alertId) {
                const alert = alerts.find(a => a.id === alertId);
                if (!alert) return;

                let detailsHtml = `
                    <h3 class="text-lg font-bold text-white mb-2">Alert #${alert.id}: ${alert.type}</h3>
                    <p class="text-sm mb-4">${alert.description}</p>
                    <div class="mb-4 text-sm space-y-2">
                        <strong class="text-gray-300">Affected Entities:</strong>
                        ${Object.entries(alert.details).map(([key, value]) => `
                            <div class="flex justify-between items-center bg-gray-800 p-2 rounded-md">
                                <span class="font-mono text-gray-400">${key.replace('_',' ')}:</span>
                                <span class="font-mono text-blue-300">${value}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div>
                         <strong class="text-gray-300">Suggested Remediation:</strong>
                         <div id="remediation-steps" class="mt-2 space-y-2">
                            ${alert.status === 'New' ? alert.remediation.map((step, index) => `
                                <button data-alert-id="${alert.id}" data-step-index="${index}" class="remediate-btn w-full text-left p-2 bg-blue-600 hover:bg-blue-700 rounded-md text-white text-sm transition-colors">
                                    ${step}
                                </button>
                            `).join('') : '<p class="text-green-400">This incident has been remediated.</p>'}
                         </div>
                    </div>
                `;
                alertDetailsPanel.innerHTML = detailsHtml;

                // Add event listeners to new buttons
                document.querySelectorAll('.remediate-btn').forEach(btn => {
                    btn.addEventListener('click', handleRemediation);
                });
            }

            // Expose handlers for inline onclick usage
            window.displayAlertDetails = displayAlertDetails;
            window.handleRemediation = handleRemediation;

            function handleRemediation(event) {
                const alertId = parseInt(event.target.dataset.alertId);
                const alert = alerts.find(a => a.id === alertId);
                if (alert) {
                    // Simulate active blocking based on alert context
                    blockThreat(alert);
                    alert.status = 'Remediated';
                    renderAlerts();
                    displayAlertDetails(alertId); // Refresh details view
                }
            }

            function blockThreat(alert) {
                // Block by source IP if present
                if (alert.details && alert.details.source_ip) {
                    blockedIPs.add(alert.details.source_ip);
                    showToast(`Blocked source IP ${alert.details.source_ip}`, 'success');
                }
                // Block by user if present
                if (alert.details && alert.details.user) {
                    blockedUsers.add(alert.details.user);
                    showToast(`Blocked user ${alert.details.user}`, 'success');
                }
                // Block by destination/domain if present
                if (alert.details && alert.details.destination) {
                    blockedDestinations.add(alert.details.destination);
                    showToast(`Blocked destination ${alert.details.destination}`, 'success');
                }
            }

            

            // Add alert to the alerts array and update UI
            function addAlert(alert) {
                alerts.push(alert);
                updateStats();
                renderAlerts();
            }

            // Generate random alert for refresh functionality
            function generateRandomAlert() {
                const alertTypes = ['Brute Force Attack', 'Malware Detection', 'Insider Threat', 'Data Exfiltration', 'DDoS Attack', 'Phishing Attempt'];
                const severities = ['High', 'Medium', 'Low'];
                const statuses = ['New', 'In Progress', 'Remediated'];
                const descriptions = [
                    'Multiple failed login attempts detected from suspicious IP',
                    'Malicious file detected and quarantined',
                    'Unauthorized access attempt to sensitive data',
                    'Large data transfer to external destination',
                    'Distributed denial of service attack in progress',
                    'Suspicious email with malicious attachment blocked'
                ];
                
                const randomType = alertTypes[Math.floor(Math.random() * alertTypes.length)];
                const randomSeverity = severities[Math.floor(Math.random() * severities.length)];
                const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                const randomDescription = descriptions[Math.floor(Math.random() * descriptions.length)];
                
                return {
                    id: Date.now(),
                    type: randomType,
                    severity: randomSeverity,
                    status: randomStatus,
                    description: randomDescription,
                    timestamp: new Date(),
                    source_ip: `192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`,
                    user: ['alice', 'bob', 'charlie', 'dave', 'eve'][Math.floor(Math.random() * 5)]
                };
            }

            // --- Automatic Real-time Processing Loop ---
            setInterval(() => {
                const log = generateLog();
                if (log) createAndProcessLog(log);
            }, 2000); // Process security events every 2 seconds automatically

            // --- Collapse Functionality ---
            function setupCollapseFunctionality() {
                // Section collapse functionality
                const sections = [
                    { toggle: 'threat-stats-toggle', content: 'threat-stats-content', chevron: 'threat-stats-chevron' },
                    { toggle: 'performance-toggle', content: 'performance-content', chevron: 'performance-chevron' },
                    { toggle: 'incident-details-toggle', content: 'incident-details-content', chevron: 'incident-details-chevron' },
                    { toggle: 'live-stream-toggle', content: 'live-stream-content', chevron: 'live-stream-chevron' },
                    { toggle: 'incidents-toggle', content: 'incidents-content', chevron: 'incidents-chevron' },
                    { toggle: 'threat-feed-toggle', content: 'threat-feed-content', chevron: 'threat-feed-chevron' }
                ];

                sections.forEach(section => {
                    const toggleBtn = document.getElementById(section.toggle);
                    const content = document.getElementById(section.content);
                    const chevron = document.getElementById(section.chevron);

                    if (toggleBtn && content && chevron) {
                        toggleBtn.addEventListener('click', () => {
                            const isCollapsed = content.style.maxHeight === '0px' || content.style.maxHeight === '';
                            
                            if (isCollapsed) {
                                content.style.maxHeight = content.scrollHeight + 'px';
                                chevron.style.transform = 'rotate(0deg)';
                            } else {
                                content.style.maxHeight = '0px';
                                chevron.style.transform = 'rotate(-90deg)';
                            }
                        });
                    }
                });

                // Show more incidents functionality
                const showMoreBtn = document.getElementById('show-more-incidents');
                if (showMoreBtn) {
                    showMoreBtn.addEventListener('click', () => {
                        const incidentsElement = document.getElementById('incidents-list');
                        const incidents = incidentsElement.children;
                        const isExpanded = showMoreBtn.textContent.includes('Show Less');
                        
                        incidents.forEach((incident, index) => {
                            if (index >= 5) {
                                incident.style.display = isExpanded ? 'none' : 'block';
                            }
                        });
                        
                        showMoreBtn.innerHTML = isExpanded ? 
                            '<i class="fas fa-chevron-down mr-2"></i>Show More Incidents' : 
                            '<i class="fas fa-chevron-up mr-2"></i>Show Less Incidents';
                    });
                }

                // Show more threats functionality
                const showMoreThreatsBtn = document.getElementById('show-more-threats');
                if (showMoreThreatsBtn) {
                    showMoreThreatsBtn.addEventListener('click', () => {
                        const threatsElement = document.getElementById('threat-feed');
                        const threats = threatsElement.children;
                        const isExpanded = showMoreThreatsBtn.textContent.includes('Show Less');
                        
                        threats.forEach((threat, index) => {
                            if (index >= 5) {
                                threat.style.display = isExpanded ? 'none' : 'block';
                            }
                        });
                        
                        showMoreThreatsBtn.innerHTML = isExpanded ? 
                            '<i class="fas fa-chevron-down mr-2"></i>Show More Threats' : 
                            '<i class="fas fa-chevron-up mr-2"></i>Show Less Threats';
                    });
                }

                // Show more logs functionality
                const showMoreLogsBtn = document.getElementById('show-more-logs');
                if (showMoreLogsBtn) {
                    showMoreLogsBtn.addEventListener('click', () => {
                        const logsElement = document.getElementById('log-feed');
                        const logs = logsElement.children;
                        const isExpanded = showMoreLogsBtn.textContent.includes('Show Less');
                        
                        logs.forEach((log, index) => {
                            if (index >= 5) {
                                log.style.display = isExpanded ? 'none' : 'block';
                            }
                        });
                        
                        showMoreLogsBtn.innerHTML = isExpanded ? 
                            '<i class="fas fa-chevron-down mr-2"></i>Show More Events' : 
                            '<i class="fas fa-chevron-up mr-2"></i>Show Less Events';
                    });
                }
            }

            // Initialize collapse functionality
            setupCollapseFunctionality();
        });
    </script>
    <script src="assets/button-functionality.js"></script>
    <script src="assets/chatbot.js"></script>
</body>
<script>
    // Sidebar Controller (static HTML)
    (function() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const mobileToggle = document.getElementById('sidebar-mobile-toggle');
        const closeBtn = document.getElementById('sidebar-close');
        const collapseTop = document.getElementById('sidebar-collapse-toggle');
        const collapseBottom = document.getElementById('sidebar-collapse-toggle-bottom');
        const main = document.getElementById('main-container');
        const STORAGE_KEY = 'smartsoc.sidebar.collapsed';

        // Initialize: desktop collapsed state
        let collapsed = false;
        try {
            const persisted = localStorage.getItem(STORAGE_KEY);
            if (persisted !== null) collapsed = persisted === 'true';
        } catch (e) {}

        function applyCollapsedState() {
            const isDesktop = window.innerWidth >= 1024;
            if (isDesktop) {
                document.body.classList.add('desktop-with-sidebar');
                document.body.classList.toggle('desktop-with-sidebar-collapsed', collapsed);
                sidebar.classList.toggle('collapsed', collapsed);
                // Update ARIA and chevrons
                const topIcon = document.getElementById('sidebar-collapse-icon-top');
                const botIcon = document.getElementById('sidebar-collapse-icon-bottom');
                const expanded = !collapsed;
                collapseTop && collapseTop.setAttribute('aria-expanded', String(expanded));
                collapseBottom && collapseBottom.setAttribute('aria-expanded', String(expanded));
                if (topIcon) topIcon.className = expanded ? 'fas fa-angle-left' : 'fas fa-angle-right';
                if (botIcon) botIcon.className = expanded ? 'fas fa-angle-left' : 'fas fa-angle-right';
            } else {
                document.body.classList.remove('desktop-with-sidebar');
                document.body.classList.remove('desktop-with-sidebar-collapsed');
                sidebar.classList.remove('collapsed');
            }
        }

        function setCollapsed(next) {
            collapsed = next;
            try { localStorage.setItem(STORAGE_KEY, String(collapsed)); } catch (e) {}
            applyCollapsedState();
        }

        // Mobile open/close
        function openMobile() {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
            document.body.classList.add('sidebar-modal-open');
            mobileToggle && mobileToggle.setAttribute('aria-expanded', 'true');
            // Focus trap entry: move focus to close button if available
            closeBtn && closeBtn.focus && closeBtn.focus();
        }
        function closeMobile() {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
            document.body.classList.remove('sidebar-modal-open');
            mobileToggle && mobileToggle.setAttribute('aria-expanded', 'false');
            // Return focus to opener for accessibility
            mobileToggle && mobileToggle.focus && mobileToggle.focus();
        }

        mobileToggle && mobileToggle.addEventListener('click', openMobile);
        overlay && overlay.addEventListener('click', closeMobile);
        closeBtn && closeBtn.addEventListener('click', closeMobile);

        // Collapse toggles (desktop)
        function toggleCollapse() { setCollapsed(!collapsed); }
        collapseTop && collapseTop.addEventListener('click', toggleCollapse);
        collapseBottom && collapseBottom.addEventListener('click', toggleCollapse);

        // Keyboard: Escape closes mobile sidebar
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.key === 'Esc') {
                if (window.innerWidth < 1024 && !sidebar.classList.contains('-translate-x-full')) {
                    closeMobile();
                }
            }
        });

        // Active link highlighting based on current path
        function markActiveLinks() {
            const links = sidebar.querySelectorAll('nav a');
            const current = location.pathname.split('/').pop();
            links.forEach((a) => {
                const href = a.getAttribute('href') || '';
                const file = href.split('/').pop();
                const isActive = file === '' ? current === '' : current === file;
                a.classList.toggle('bg-slate-800', isActive);
                a.classList.toggle('text-white', isActive);
                // Left accent bar
                a.style.boxShadow = isActive ? 'inset 3px 0 0 0 rgb(99 102 241)' : '';
            });
        }

        // Initial setup
        function init() {
            if (window.innerWidth >= 1024) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.add('hidden');
            } else {
                // Ensure mobile starts uncollapsed layout
                document.body.classList.remove('desktop-with-sidebar');
                document.body.classList.remove('desktop-with-sidebar-collapsed');
                sidebar.classList.remove('collapsed');
            }
            applyCollapsedState();
            markActiveLinks();
        }
        init();

        // Active link highlighting
        (function markActiveLinks(){
            const links = sidebar.querySelectorAll('nav a');
            const current = location.pathname.split('/').pop();
            links.forEach(a => {
                const href = a.getAttribute('href') || '';
                const file = href.split('/').pop();
                const isActive = file === '' ? current === '' : current === file;
                a.classList.toggle('active', isActive);
                if (isActive) {
                    a.style.boxShadow = 'inset 3px 0 0 0 rgb(99 102 241)';
                    a.classList.add('text-white');
                    a.classList.add('bg-slate-800');
                }
            });
        })();
        // Keyboard navigation and collapsed tooltips
        (function enhanceA11y(){
            const navLinks = Array.from(sidebar.querySelectorAll('nav a'));
            sidebar.addEventListener('keydown', (e) => {
                if (!['ArrowDown','ArrowUp','Home','End'].includes(e.key)) return;
                const active = document.activeElement;
                const idx = navLinks.indexOf(active);
                let nextIdx = idx;
                if (e.key === 'ArrowDown') nextIdx = Math.min(navLinks.length-1, idx + 1);
                if (e.key === 'ArrowUp') nextIdx = Math.max(0, idx - 1);
                if (e.key === 'Home') nextIdx = 0;
                if (e.key === 'End') nextIdx = navLinks.length - 1;
                if (nextIdx !== idx && navLinks[nextIdx]) {
                    e.preventDefault();
                    navLinks[nextIdx].focus();
                }
            });
            function syncCollapsedTooltips() {
                const isCollapsed = sidebar.classList.contains('sidebar-collapsed') && window.innerWidth >= 1024;
                navLinks.forEach(a => {
                    const label = (a.textContent || '').trim();
                    if (isCollapsed) a.setAttribute('title', label);
                    else a.removeAttribute('title');
                });
            }
            syncCollapsedTooltips();
            window.addEventListener('resize', syncCollapsedTooltips);
        })();

        window.addEventListener('resize', applyCollapsedState);
    })();

</script>

<!-- Load threat simulation engine -->
<script src="assets/threat-simulator.js"></script>
<script src="assets/threat-map.js"></script>
</html>
